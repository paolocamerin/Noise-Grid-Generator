
  <head>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">

    <style>
      body,
      canvas,
      html {
        margin: 0;
        padding: 0;
      }
      p{
        flex: 1;
      }
      button{
        flex: 1;
      }
      h1{
        font-size: 24px;
      }
      input[type="range"] {
        width: 100%; /* Make the slider take up the full width of the container */
        grid-row: 2; /* Position the slider in the second row of the grid */
      }
      input[type="number"] {
        width: 80px;
        margin-top: 5px;
        border-radius: 4px;
        border: solid 1px rgb(200, 200, 200);
      }

      label {
        display: block;
      }

      .inputsContainer {
        display: flex;
        flex-direction: row;
        justify-content: left;
        align-items: center;
        flex: 1;
        margin-top: 10px;
        max-width: 100%;
        
        gap: 16px;

      }

      
      
      /* .labledContainer {
        display: flex;
        flex-direction: column;
        flex: 0.5;
        justify-content: left;
        max-width: 100px;
        margin-top: 5px;
      } */
      
      
      .flex {
        display: flex;
        padding: 4px;
        gap: 16px;
        flex: 1;
        justify-content: space-between;
      }
      .cta{
        background-color: #0D8CE9;
        color: white; 
      }
      .titleContainer{
        display: flex;
        padding: 8px;
        flex: 1;
        justify-content: center;
      }
      
      .mainContainer{
        padding: 8px;
      }
      #buttons{
        margin-top: 20px;
      }

      


   </style> 
  </head>
  <body>
    <!-- <canvas id="myCanvas" width="200" height="200"></canvas> -->
    <div class="titleContainer">
      <h2>Noise grid generator</h2>
    </div>
    
    <div id="canvasContainer"></div>
    <div class="mainContainer">  
      
      <div class="inputsContainer">
        <div class="labeldContainer" class="singleInput">
          <label for="x_count">X count:</label>
          <input id="x_count" value="10" type="number"min="2" />
        </div>
        <div class="labeldContainer">
          <label for="y_count">Y count:</label>
          <input id="y_count" value="10" type="number" min="2" />
        </div>
      </div>
      
      <div class="inputsContainer">
        <div class="labeldContainer">
          <label for="dimension">Dot size:</label>
          <input id="dimension" value="4" type="number" min="0" />
        </div>
      </div>

      <div class="inputsContainer">
        <div class="labeldContainer">
          <label for="x_gap">X gap:</label>
          <input id="x_gap" value="10" type="number" min="0"/>
        </div>
        <div class="labeldContainer">
          <label for="y_gap">Y gap:</label>
          <input id="y_gap" value="10" type="number" min="0"/>
        </div>
      </div>
  
      <p>
        Displacement offset:
        <input
          id="disp_off"
          type="range"
          value="0"
          min="-200"
          max="200"
          step="1"
        />
      </p>
      <p>
        Smoothness:
        <input id="factor" type="range" value="10" min="1" max="50" step="1" />
      </p>
      
      <p>
        Noise seed:
        <input id="noiseXOffset" type="range" value="100" min="1" max="200" step="1" />
      </p>
   <div id="buttons" class="flex">
     <button class="cta"id="create">Create</button>
     <button id="cancel">Cancel</button>
   </div>
    </div>

    <script>
      const x_textbox = document.getElementById("x_count");
      const y_textbox = document.getElementById("y_count");
      const dimension_textbox = document.getElementById("dimension");
      const x_gap_textbox = document.getElementById("x_gap");
      const y_gap_textbox = document.getElementById("y_gap");
      const displacement_slider = document.getElementById("disp_off");
      const factor_slider = document.getElementById("factor");
      const noiseXOffsetSlider = document.getElementById("noiseXOffset");

      let dots = [];

      // p5.js sketch code goes here
      let cnv;
     
      function setup() {
        cnv = createCanvas(windowWidth, 200);

        cnv.parent("canvasContainer");

        const inputs = document.querySelectorAll("input");
        for (let i = 0; i < inputs.length; i++) {
          inputs[i].addEventListener("input", generateGrid);
        }
        generateGrid();
      }

      function draw() {
        background(245);
        
        fill(42);
        noStroke();
        const margin = 10; 
        translate(width/2,height/2);
        for (let d of dots) {
          // if(d.x<width-margin && d.x > margin && d.y<height-margin && d.y>margin){
          //   ellipse(d.x, d.y, d.dimension, d.dimension);
          // }  
            // const maxW = (d.xGap+d.dimension/2)*d.xCount;
            // const maxH = (d.yGap+d.dimension/2)*d.yCount;
            // const ratio2 = (width-margin*2)/maxW;
            // const mappedX = (d.x-maxW/2+d.xGap+d.dimension/2)*ratio2;
            // const mappedY = (d.y-maxH/2+d.yGap+d.dimension/2)*ratio2; 
            // const mappedDim = d.dimension*ratio2;
            let scalingFactor;

            const maxW = (d.xGap+d.dimension)*d.xCount;
            const maxH = (d.yGap+d.dimension)*d.yCount;
            const initialGridAspectRatio = maxW/maxH;
            const canvasAspectRatio = width/height;
            
            if(initialGridAspectRatio>canvasAspectRatio){
               scalingFactor = width/maxW;
            }else{
               scalingFactor = height/maxH;
            }
            const mappedXGap = d.xGap*scalingFactor;
            const mappedYGap = d.yGap*scalingFactor;
            const mappedDim = d.dimension*scalingFactor;
            const mappedX = (d.x-maxW/2)*scalingFactor+(mappedDim+mappedXGap)/2;
            
            const mappedY = (d.y-maxH/2)*scalingFactor+(mappedDim+mappedYGap)/2;
            
            //const mappedY = (d.y-maxH/2+d.yGap+d.dimension/2)*ratio2; 
            
            ellipse(mappedX, mappedY, mappedDim, mappedDim);

         
        }

        noLoop();
      }

    
     

     
      function generateGrid() {
        dots = [];
        const x_count = parseInt(x_textbox.value, 10);
        const y_count = parseInt(y_textbox.value, 10);
        const dimension = parseInt(dimension_textbox.value, 10);
        const x_gap = parseInt(x_gap_textbox.value, 10);
        const y_gap = parseInt(y_gap_textbox.value, 10);
        const displacement = parseInt(displacement_slider.value, 10);
        const factor = parseInt(factor_slider.value, 10);
        const xOffset = parseInt(noiseXOffsetSlider.value, 10); 
        let index = 0;
        
        for (let x = 0; x < x_count; x++) {
          for (let y = 0; y < y_count; y++) {
            dots.push({
              name: `Circle ${index}`,
              x: x * (x_gap + dimension ) + displacement*cos(map(noise(x / factor+xOffset, y / factor+300),0,1,-PI,PI)),
              y: y * (y_gap + dimension ) + displacement*sin(map(noise(x / factor+xOffset, y / factor+300),0,1,-PI,PI)),
              xIndex: x,
              yIndex: y,
              xCount: x_count,
              yCount: y_count, 
              dimension: dimension,
              xGap: x_gap,
              yGap: y_gap, 
              factor: factor,
            });
            index++;
          }
        }

        redraw();
      }

      document.getElementById("create").onclick = () => {
        parent.postMessage(
          {
            pluginMessage: {
              type: "create-grid",
              dots,
            },
          },
          "*"
        );
      };

      document.getElementById("cancel").onclick = () => {
        parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
      };
    </script>
  </body>
</html>
